<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Meeting Settings</title>
    <style>
        /* CSS hi·ªán c√≥ c·ªßa b·∫°n (gi·ªØ nguy√™n c√°c ph·∫ßn kh√°c) */
body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background-color: #f7f7f9;
    margin: 0;
}

.preview-container {
    width: 50%;
    display: flex;
    flex-direction: column;
    gap: 20px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.video-preview {
    width: 320px;
    height: 240px;
    background: black;
    margin: 0 auto;
    object-fit: cover;
    border-radius: 5px;
}

.controls {
    width: 100%; /* ƒê·∫£m b·∫£o .controls chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa .preview-container */
    display: flex;
    justify-content: space-between; /* Gi·ªØ layout hi·ªán t·∫°i */
    gap: 5px;
}

.button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
}

button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.startMeetingRoom {
    display: flex;
    text-decoration: none;
    justify-content: end;
}
.btn-audio { background-color: #007bff; color: white; }
.btn-video { background-color: #28a745; color: white; }
.btn-start { 
    background-color: #0056b3; 
    color: white; 
    width: 100px;
    padding: 10px;
}


/* ƒêi·ªÅu ch·ªânh CSS cho select-micro v√† select-camera */
.select-micro, .select-camera {
    width: 100%; /* ƒê·∫£m b·∫£o m·ªói ph·∫ßn t·ª≠ con chi·∫øm to√†n b·ªô kh√¥ng gian c√≥ s·∫µn */
}

.select-micro select, .select-camera select {
    padding: 8px 30px 8px 10px; /* Gi·ªØ padding cho m≈©i t√™n */
    font-size: 14px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    background-color: #fff;
    color: #333;
    appearance: none;
    cursor: pointer;
    width: 100%; /* ƒê·∫∑t chi·ªÅu r·ªông 100% ƒë·ªÉ chi·∫øm to√†n b·ªô kh√¥ng gian c·ªßa cha */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: border-color 0.3s ease;
}

.select-micro select:hover, .select-camera select:hover {
    border-color: #007bff;
}

.select-micro select:focus, .select-camera select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}
    </style>
</head>
<body>
    <div class="preview-container">
        <video id="videoPreview" autoplay playsinline>
            
        </video>
        <!-- <button class="btn-audio" onclick="toggleAudio()">üîá T·∫Øt Mic</button>
        <button class="btn-video" onclick="toggleVideo()">üìπ T·∫Øt Camera</button> -->
        <div class="controls">
            <div class="select-micro">
                <select id="microSelect"></select>
            </div>

            <div class="select-camera">
                <select id="cameraSelect"></select>
            </div>        
            
        </div>
        <a href="{{ url_for('meeting', room_id=room_id) }}" class="startMeetingRoom">
            <button class="btn-start">B·∫Øt ƒë·∫ßu</button>
        </a>
    </div>

    <script>
        let micEnabled = true;
        let camEnabled = true;
        let stream = null;
        let videoElement = document.getElementById("videoPreview");
        let cameraSelect = document.getElementById("cameraSelect");
        let microSelect = document.getElementById("microSelect"); // Th√™m tham chi·∫øu ƒë·∫øn dropdown micro

        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === "videoinput");

                cameraSelect.innerHTML = ""; // X√≥a danh s√°ch c≈©

                videoDevices.forEach((device, index) => {
                    const option = document.createElement("option");
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });

                // L·∫•y camera ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥ (n·∫øu c√≥) t·ª´ localStorage
                const savedCameraId = localStorage.getItem("selectedCameraId");
                if (savedCameraId && videoDevices.some(device => device.deviceId === savedCameraId)) {
                    cameraSelect.value = savedCameraId;
                    await startCamera(savedCameraId);
                } else if (videoDevices.length > 0) {
                    cameraSelect.value = videoDevices[0].deviceId;
                    await startCamera(videoDevices[0].deviceId);
                    localStorage.setItem("selectedCameraId", videoDevices[0].deviceId); // L∆∞u camera m·∫∑c ƒë·ªãnh
                }
            } catch (err) {
                console.error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch camera:", err);
            }
        }

        async function startCamera(deviceId) {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop()); // D·ª´ng camera c≈©
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId }, width: 320, height: 200 },
                    audio: true
                });

                videoElement.srcObject = stream;
                localStorage.setItem("selectedCameraId", deviceId); // L∆∞u camera ƒë√£ ch·ªçn
                camEnabled = true;
                updateVideoStatus();
            } catch (err) {
                console.error("Kh√¥ng th·ªÉ m·ªü camera:", err);
                alert("Kh√¥ng th·ªÉ m·ªü camera. Ki·ªÉm tra quy·ªÅn & thi·∫øt b·ªã!");
            }
        }

        async function initializeMicrophones() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === "audioinput");

                microSelect.innerHTML = ""; // X√≥a danh s√°ch c≈©

                audioDevices.forEach((device, index) => {
                    const option = document.createElement("option");
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${index + 1}`;
                    microSelect.appendChild(option);
                });

                // L·∫•y microphone ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥ (n·∫øu c√≥) t·ª´ localStorage
                const savedMicrophoneId = localStorage.getItem("selectedMicrophoneId");
                if (savedMicrophoneId && audioDevices.some(device => device.deviceId === savedMicrophoneId)) {
                    microSelect.value = savedMicrophoneId;
                    await startMicrophone(savedMicrophoneId);
                } else if (audioDevices.length > 0) {
                    microSelect.value = audioDevices[0].deviceId;
                    await startMicrophone(audioDevices[0].deviceId);
                    localStorage.setItem("selectedMicrophoneId", audioDevices[0].deviceId); // L∆∞u micro m·∫∑c ƒë·ªãnh
                }
            } catch (err) {
                console.error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch micro:", err);
                alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch micro. Ki·ªÉm tra quy·ªÅn & thi·∫øt b·ªã!");
            }
        }

        async function startMicrophone(deviceId) {
            try {
                if (window.currentStream) {
                    window.currentStream.getTracks().forEach(track => track.stop());
                }

                window.currentStream = await navigator.mediaDevices.getUserMedia({
                    audio: { deviceId: { exact: deviceId } },
                    video: false
                });

                // K·∫øt h·ª£p stream audio v·ªõi stream video (n·∫øu c√≥)
                if (stream && stream.getVideoTracks().length > 0) {
                    const combinedStream = new MediaStream();
                    combinedStream.addTrack(stream.getVideoTracks()[0]);
                    combinedStream.addTrack(window.currentStream.getAudioTracks()[0]);
                    videoElement.srcObject = combinedStream;
                    stream = combinedStream;
                }

                localStorage.setItem("selectedMicrophoneId", deviceId); // L∆∞u microphone ƒë√£ ch·ªçn
                micEnabled = true;
                updateAudioStatus();
                console.log("Microphone started successfully with deviceId:", deviceId);
            } catch (err) {
                console.error("Kh√¥ng th·ªÉ m·ªü micro:", err);
                alert("Kh√¥ng th·ªÉ m·ªü micro. Ki·ªÉm tra quy·ªÅn & thi·∫øt b·ªã!");
            }
        }

        function toggleAudio() {
            if (stream && stream.getAudioTracks().length > 0) {
                micEnabled = !micEnabled;
                stream.getAudioTracks()[0].enabled = micEnabled;
                document.querySelector(".btn-audio").innerText = micEnabled ? "üîá T·∫Øt Mic" : "üéôÔ∏è B·∫≠t Mic";
            }
        }

        function toggleVideo() {
            if (stream && stream.getVideoTracks().length > 0) {
                camEnabled = !camEnabled;
                stream.getVideoTracks()[0].enabled = camEnabled;
                document.querySelector(".btn-video").innerText = camEnabled ? "üìπ T·∫Øt Camera" : "üì∑ B·∫≠t Camera";
            }
        }

        function startMeeting() {
            alert("B·∫Øt ƒë·∫ßu cu·ªôc h·ªçp!");
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn meeting-room
            window.location.href = "meeting-room.html";
        }

        // Khi ch·ªçn camera m·ªõi, c·∫≠p nh·∫≠t lu·ªìng video
        cameraSelect.addEventListener("change", function () {
            startCamera(this.value);
        });

        // Khi ch·ªçn micro m·ªõi, c·∫≠p nh·∫≠t lu·ªìng audio
        microSelect.addEventListener("change", function () {
            startMicrophone(this.value);
        });

        function updateVideoStatus() {
            const videoStatus = document.querySelector(".control-item:nth-child(2) .control-status");
            if (videoStatus) {
                videoStatus.textContent = camEnabled ? "‚úî" : "‚úï";
                videoStatus.style.backgroundColor = camEnabled ? "#2EB62C" : "red";
            }
        }

        function updateAudioStatus() {
            const audioStatus = document.querySelector(".control-item:nth-child(1) .control-status");
            if (audioStatus) {
                audioStatus.textContent = micEnabled ? "‚úî" : "‚úï";
                audioStatus.style.backgroundColor = micEnabled ? "#2EB62C" : "red";
            }
        }

        // Khi t·∫£i trang, l·∫•y danh s√°ch camera v√† micro
        document.addEventListener("DOMContentLoaded", getCameras);
        document.addEventListener("DOMContentLoaded", initializeMicrophones);
    </script>
</body>
</html>
